<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NHM | Government of India Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #002140; 
            --accent: #1890ff; 
            --tiranga-orange: #FF9933; 
            --tiranga-white: #FFFFFF; 
            --tiranga-green: #138808;
            --danger: #d9363e;
            --success: #237804;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(180deg, var(--tiranga-orange) 0%, var(--tiranga-white) 50%, var(--tiranga-green) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        /* Watermark Background */
        body::before {
            content: "";
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Emblem_of_India.svg/800px-Emblem_of_India.svg.png') no-repeat center;
            background-size: contain;
            opacity: 0.05;
            z-index: -1;
        }

        #login-page { height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { 
            background: rgba(255, 255, 255, 0.98); 
            padding: 40px; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border-top: 6px solid var(--tiranga-orange);
        }

        .emblem { width: 60px; margin-bottom: 20px; }
        #dashboard-page { display: none; padding: 15px; }
        
        .header-strip { 
            background: white; padding: 15px; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }

        @media (min-width: 600px) {
            .header-strip { flex-direction: row; justify-content: space-between; }
        }

        .main-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1000px) { .main-layout { grid-template-columns: 2fr 1fr; } }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 16px; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; width: 100%; }
        .btn:active { opacity: 0.8; transform: scale(0.98); }

        .table-container { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 10px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 13px; }
    </style>
</head>
<body>

<div id="login-page">
    <div class="auth-card" id="login-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Emblem_of_India.svg/800px-Emblem_of_India.svg.png" class="emblem">
        <h2 style="color:var(--primary); margin:0;">NHM Portal</h2>
        <p style="color:#888; font-size: 12px; margin-bottom: 25px;">National Health Mission Fund Sync</p>
        <input type="text" id="l-user" placeholder="Official Email">
        <input type="password" id="l-pass" placeholder="Password">
        <button class="btn" style="background:var(--primary)" onclick="login()">Login</button>
        <p onclick="toggleAuth(false)" style="font-size:12px; cursor:pointer; color:var(--accent); margin-top:20px;">Forgot Password?</p>
    </div>
    <div class="auth-card" id="forgot-box" style="display:none">
        <h3>Reset Request</h3>
        <input type="email" id="f-email" placeholder="Enter Gmail">
        <button class="btn" style="background:var(--tiranga-green)" onclick="forgotPassword()">Notify Admin</button>
        <p onclick="toggleAuth(true)" style="font-size:12px; cursor:pointer; margin-top:20px;">Back</p>
    </div>
</div>

<div id="dashboard-page">
    <div class="header-strip">
        <h2 id="totalVal" style="color:var(--tiranga-orange); margin:0;">₹0</h2>
        <div style="display:flex; align-items:center; gap:15px;">
            <div style="text-align:right;">
                <div id="userTag" style="font-weight:bold; color:var(--primary); font-size:14px;"></div>
                <small id="roleTag" style="color:var(--tiranga-green)"></small>
            </div>
            <button class="btn" style="background:#8c8c8c; width:auto; padding:8px 15px;" onclick="location.reload()">Logout</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="content-left">
            <div class="card" style="height:350px; margin-bottom:20px;">
                <canvas id="financeChart"></canvas>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Audit Logs</h3>
                    <button class="btn" style="background:#2f54eb; width:auto;" onclick="downloadAuditCSV()">Export CSV</button>
                </div>
                <div class="table-container">
                    <table id="logTable">
                        <thead><tr><th>Time</th><th>User</th><th>State</th><th>Action</th><th>Amount</th><th>Note</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="content-right">
            <div class="card">
                <h3>Sync Funds</h3>
                <select id="stSelect"></select>
                <input type="number" id="amt" placeholder="Amount (₹)">
                <textarea id="reason" rows="3" placeholder="Usage description (Mandatory)"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="background:var(--success)" onclick="sync('add')">RELEASE</button>
                    <button class="btn" style="background:var(--danger)" onclick="sync('sub')">RECALL</button>
                </div>
            </div>

            <div id="adminPanel" class="card" style="display:none; margin-top:20px; border-top:4px solid var(--tiranga-orange);">
                <h3>Admin: Add Officer</h3>
                <input type="email" id="new-gmail" placeholder="New Officer Email">
                <input type="password" id="new-pass" placeholder="Initial Password">
                <button class="btn" style="background:var(--primary)" onclick="addClient()">Create Account</button>
                <button class="btn" style="background:var(--danger); margin-top:10px;" onclick="clearLogs()">Clear All Logs</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Replace this URL with your live Render/PythonAnywhere URL
    const API = "http://127.0.0.1:5000/api"; 

    const states = ["Andaman & Nicobar", "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chandigarh", "Chhattisgarh", "Dadra & Nagar Haveli", "Delhi", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jammu & Kashmir", "Jharkhand", "Karnataka", "Kerala", "Ladakh", "Lakshadweep", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Puducherry", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"].sort();
    
    let activeUser, chart, userRole, currentLogs = [];

    function toggleAuth(show) {
        document.getElementById('login-box').style.display = show ? 'block' : 'none';
        document.getElementById('forgot-box').style.display = show ? 'none' : 'block';
    }

    async function login() {
        const username = document.getElementById('l-user').value;
        const password = document.getElementById('l-pass').value;
        try {
            const res = await fetch(`${API}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if(res.ok) {
                activeUser = data.user; userRole = data.role;
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('dashboard-page').style.display = 'block';
                document.getElementById('userTag').innerText = activeUser;
                document.getElementById('roleTag').innerText = userRole.toUpperCase() + " ACCESS";
                if(userRole === 'admin') document.getElementById('adminPanel').style.display = 'block';
                initChart();
            } else alert(data.error);
        } catch(e) { alert("Cannot connect to server."); }
    }

    function initChart() {
        const ctx = document.getElementById('financeChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: states, datasets: [{ label: 'Allocation (₹)', data: states.map(()=>0), backgroundColor: '#FF9933' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        loadData();
    }

    async function loadData() {
        const res = await fetch(`${API}/funds`);
        const data = await res.json();
        currentLogs = data.logs;
        chart.data.datasets[0].data = states.map(s => data.funds[s] || 0);
        chart.update();
        document.getElementById('stSelect').innerHTML = states.map(s => `<option>${s}</option>`).join('');
        document.getElementById('totalVal').innerText = "₹ " + Object.values(data.funds).reduce((a,b)=>a+b, 0).toLocaleString('en-IN');
        document.getElementById('logTable').querySelector('tbody').innerHTML = data.logs.map(l => 
            `<tr><td>${l.time}</td><td>${l.user}</td><td>${l.s}</td><td style="font-weight:bold; color:${l.type=='add'?'#237804':'#d9363e'}">${l.type.toUpperCase()}</td><td>₹${l.a.toLocaleString()}</td><td>${l.n}</td></tr>`
        ).join('');
    }

    async function sync(type) {
        const amount = document.getElementById('amt').value;
        const note = document.getElementById('reason').value;
        if(!amount || !note) return alert("Justification is mandatory for audit trail.");
        await fetch(`${API}/sync`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ state: document.getElementById('stSelect').value, amount: parseFloat(amount), type, note, user: activeUser })
        });
        loadData();
        document.getElementById('amt').value = ''; document.getElementById('reason').value = '';
    }

    function downloadAuditCSV() {
        let csv = "Timestamp,User,State,Type,Amount,Note\n";
        currentLogs.forEach(l => csv += `${l.time},${l.user},${l.s},${l.type},${l.a},"${l.n}"\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'NHM_Audit_Log.csv'; a.click();
    }

    async function addClient() {
        const gmail = document.getElementById('new-gmail').value;
        const password = document.getElementById('new-pass').value;
        const res = await fetch(`${API}/admin/add-client`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ gmail, password })
        });
        const d = await res.json(); alert(d.message || d.error);
    }

    async function clearLogs() {
        if(confirm("Permanently delete audit history?")) {
            await fetch(`${API}/admin/clear-logs`, { method: 'POST' });
            loadData();
        }
    }

    async function forgotPassword() {
        const email = document.getElementById('f-email').value;
        await fetch(`${API}/forgot-password`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email })
        });
        alert("Reset request sent to administrator."); toggleAuth(true);
    }
</script>
</body>
</html>